<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل ادمین - جزئیات کاربر</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
    </style>
    <!-- CSS and JS modules -->
    <link rel="stylesheet" href="../assets/vazirmatn.css">
    <link rel="stylesheet" href="../user/styles.css">
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <meta name="robots" content="noindex, nofollow">

    <!-- Header -->
    <header class="bg-white shadow p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <span id="gym-name">باشگاه</span> - پنل ادمین
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <nav class="hidden md:flex space-x-4 space-x-reverse">
                    <a href="admins-index.html" class="text-gray-600 hover:text-blue-500 font-bold">داشبورد</a>
                    <a href="users.html" class="text-gray-600 hover:text-blue-500 font-bold">اعضا</a>
                    <a href="admins.html" class="text-gray-600 hover:text-blue-500 font-bold">مدیران</a>
                    <a href="reports.html" class="text-gray-600 hover:text-blue-500 font-bold">گزارشات</a>
                </nav>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-600 hover:text-blue-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <nav id="mobile-menu" class="md:hidden mt-2 hidden text-center space-y-2">
            <a href="admins-index.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">داشبورد</a>
            <a href="users.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">اعضا</a>
            <a href="admins.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">مدیران</a>
            <a href="reports.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">گزارشات</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div id="user-profile">
                <h2 id="user-full-name" class="text-3xl font-bold mb-2 text-gray-800"></h2>
                <p id="user-membership-code" class="text-gray-600 text-lg mb-1"></p>
                <p id="user-phone" class="text-gray-600 text-lg mb-1"></p>
                <p id="user-status" class="text-lg font-semibold"></p>
            </div>
            
            <hr class="my-6">
            
            <!-- Subscription Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">اشتراک‌ها</h3>
                <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 md:space-x-reverse mb-6">
                    <input type="number" id="extend-days-input" placeholder="تعداد روز" class="flex-grow p-2 rounded-full border border-gray-300">
                    <button id="extend-sub-btn" class="bg-green-500 text-white py-2 px-4 rounded-full font-medium hover:bg-green-600 transition-colors duration-200">تمدید</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100 text-right">
                                <th class="py-2 px-4">تاریخ شروع</th>
                                <th class="py-2 px-4">تاریخ پایان</th>
                                <th class="py-2 px-4">وضعیت</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptions-table-body" class="divide-y divide-gray-200">
                            <!-- Subscription rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <hr class="my-6">

            <!-- Attendance Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">حضور و غیاب</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100 text-right">
                                <th class="py-2 px-4">تاریخ</th>
                                <th class="py-2 px-4">وضعیت</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body" class="divide-y divide-gray-200">
                            <!-- Attendance rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-4 text-center text-gray-500 text-sm">
        <p>&copy; 2025 پلتفرم مدیریت باشگاه. تمامی حقوق محفوظ است.</p>
    </footer>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';

        // Initialize Supabase client
        const SUPABASE_URL = 'https://mchjfnbbfmslocmexwxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jaGpmbmJiZm1zbG9jbWV4d3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODk4ODcsImV4cCI6MjA3MTM2NTg4N30.IzJfkGRfyS7fLdTXu0yckGwKRFVt_wMFLZY8g68qBnM';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');

        // Function to fetch and display user details
        async function fetchUserDetails() {
            if (!userId) {
                console.error('User ID not found in URL.');
                return;
            }
            
            const { data: user, error: userError } = await supabase.from('users').select('*').eq('id', userId).single();
            if (userError) {
                console.error('Error fetching user details:', userError);
                return;
            }
            
            document.getElementById('user-full-name').textContent = user.full_name;
            document.getElementById('user-membership-code').textContent = `کد عضویت: ${user.membership_code}`;
            document.getElementById('user-phone').textContent = `شماره تلفن: ${user.phone}`;
            document.getElementById('user-status').textContent = `وضعیت: ${user.status}`;
            
            // Fetch and display subscriptions
            const { data: subscriptions, error: subError } = await supabase
                .from('subscriptions')
                .select('*')
                .eq('user_id', userId)
                .order('end_date', { ascending: false });
            
            if (!subError) {
                const subTableBody = document.getElementById('subscriptions-table-body');
                subTableBody.innerHTML = '';
                subscriptions.forEach(sub => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 text-right';
                    const startDate = new Date(sub.start_date).toLocaleDateString('fa-IR');
                    const endDate = new Date(sub.end_date).toLocaleDateString('fa-IR');
                    row.innerHTML = `
                        <td class="py-2 px-4">${startDate}</td>
                        <td class="py-2 px-4">${endDate}</td>
                        <td class="py-2 px-4">${sub.status}</td>
                    `;
                    subTableBody.appendChild(row);
                });
            }

            // Fetch and display attendance
            const { data: sessions, error: sessionError } = await supabase
                .from('sessions')
                .select('*')
                .eq('user_id', userId)
                .order('session_date', { ascending: false });

            if (!sessionError) {
                const attTableBody = document.getElementById('attendance-table-body');
                attTableBody.innerHTML = '';
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 text-right';
                    const sessionDate = new Date(session.session_date).toLocaleDateString('fa-IR');
                    row.innerHTML = `
                        <td class="py-2 px-4">${sessionDate}</td>
                        <td class="py-2 px-4">حاضر</td>
                    `;
                    attTableBody.appendChild(row);
                });
            }
        }
        
        // Function to extend subscription
        async function extendSubscription() {
            const days = document.getElementById('extend-days-input').value;
            if (!days || days <= 0) {
                console.error('Please enter a valid number of days.');
                return;
            }

            const { data: latestSub, error: subError } = await supabase
                .from('subscriptions')
                .select('*')
                .eq('user_id', userId)
                .order('end_date', { ascending: false })
                .limit(1)
                .single();

            let startDate;
            let endDate;
            if (latestSub) {
                // Extend from the last end date
                const lastEndDate = new Date(latestSub.end_date);
                lastEndDate.setDate(lastEndDate.getDate() + 1);
                startDate = lastEndDate.toISOString().split('T')[0];
                const newEndDate = new Date(lastEndDate);
                newEndDate.setDate(newEndDate.getDate() + parseInt(days));
                endDate = newEndDate.toISOString().split('T')[0];
            } else {
                // New subscription starting today
                const today = new Date();
                startDate = today.toISOString().split('T')[0];
                const newEndDate = new Date(today);
                newEndDate.setDate(newEndDate.getDate() + parseInt(days));
                endDate = newEndDate.toISOString().split('T')[0];
            }

            const { data, error } = await supabase
                .from('subscriptions')
                .insert([{ user_id: userId, start_date: startDate, end_date: endDate, status: 'فعال' }]);
            
            if (error) {
                console.error('Error extending subscription:', error);
                return;
            }

            console.log('Subscription extended successfully:', data);
            document.getElementById('extend-days-input').value = '';
            fetchUserDetails(); // Refresh data
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserDetails();
            document.getElementById('extend-sub-btn').addEventListener('click', extendSubscription);
            document.getElementById('menu-btn').addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobile-menu');
                mobileMenu.classList.toggle('hidden');
            });
        });
    </script>
</body>
</html>