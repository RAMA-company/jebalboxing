<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل ادمین - گزارشات</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
    </style>
    <!-- CSS and JS modules -->
    <link rel="stylesheet" href="../assets/vazirmatn.css">
    <link rel="stylesheet" href="../user/styles.css">
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <meta name="robots" content="noindex, nofollow">

    <!-- Header -->
    <header class="bg-white shadow p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <span id="gym-name">باشگاه</span> - پنل ادمین
            </h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <nav class="hidden md:flex space-x-4 space-x-reverse">
                    <a href="admins-index.html" class="text-gray-600 hover:text-blue-500 font-bold">داشبورد</a>
                    <a href="users.html" class="text-gray-600 hover:text-blue-500 font-bold">اعضا</a>
                    <a href="admins.html" class="text-gray-600 hover:text-blue-500 font-bold">مدیران</a>
                    <a href="reports.html" class="text-blue-500 font-bold">گزارشات</a>
                </nav>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-600 hover:text-blue-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <nav id="mobile-menu" class="md:hidden mt-2 hidden text-center space-y-2">
            <a href="admins-index.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">داشبورد</a>
            <a href="users.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">اعضا</a>
            <a href="admins.html" class="block py-2 text-gray-600 hover:text-blue-500 font-bold">مدیران</a>
            <a href="reports.html" class="block py-2 text-blue-500 font-bold">گزارشات</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        <div class="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">تهیه گزارش</h2>
            <div class="space-y-4">
                <div>
                    <label for="report-type" class="block text-gray-700 font-bold mb-2">نوع گزارش:</label>
                    <select id="report-type" class="w-full p-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="users">اعضا</option>
                        <option value="subscriptions">اشتراک‌ها</option>
                        <option value="sessions">حضور و غیاب</option>
                        <option value="admins">مدیران</option>
                        <option value="logs">لاگ‌ها</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <label for="start-date" class="block text-gray-700">از تاریخ:</label>
                    <input type="date" id="start-date" class="flex-grow p-2 rounded-full border border-gray-300">
                    <label for="end-date" class="block text-gray-700">تا تاریخ:</label>
                    <input type="date" id="end-date" class="flex-grow p-2 rounded-full border border-gray-300">
                </div>
                <button id="generate-report-btn" class="w-full bg-blue-500 text-white py-3 px-4 rounded-full font-bold hover:bg-blue-600 transition-colors duration-200">
                    تهیه گزارش
                </button>
            </div>
            
            <!-- Download Link Placeholder -->
            <div id="download-link-container" class="mt-6 hidden">
                <a href="#" id="download-link" class="text-green-600 font-bold hover:underline">
                    دانلود فایل CSV
                </a>
            </div>
            
            <!-- Report Table -->
            <div class="mt-6 overflow-x-auto">
                <table id="report-table" class="min-w-full bg-white rounded-lg">
                    <thead>
                        <!-- Table headers will be generated by JS -->
                    </thead>
                    <tbody>
                        <!-- Table rows will be generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-4 text-center text-gray-500 text-sm">
        <p>&copy; 2025 پلتفرم مدیریت باشگاه. تمامی حقوق محفوظ است.</p>
    </footer>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';

        // Initialize Supabase client
        const SUPABASE_URL = 'https://mchjfnbbfmslocmexwxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jaGpmbmJiZm1zbG9jbWV4d3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODk4ODcsImV4cCI6MjA3MTM2NTg4N30.IzJfkGRfyS7fLdTXu0yckGwKRFVt_wMFLZY8g68qBnM';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to fetch and generate report
        async function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            let query = supabase.from(reportType).select('*');
            if (startDate) {
                query = query.gte('created_at', startDate);
            }
            if (endDate) {
                query = query.lte('created_at', endDate);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Error generating report:', error);
                return;
            }

            // Display report in a table and create CSV
            const table = document.getElementById('report-table');
            const downloadLinkContainer = document.getElementById('download-link-container');
            const downloadLink = document.getElementById('download-link');

            // Clear previous report
            table.innerHTML = '';
            downloadLinkContainer.classList.add('hidden');

            if (data.length === 0) {
                table.innerHTML = '<tr><td colspan="100%" class="text-center py-4">گزارشی یافت نشد.</td></tr>';
                return;
            }

            // Create table headers
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.className = 'py-3 px-6 text-gray-600 font-bold text-right';
                headerRow.appendChild(th);
            });
            const thead = document.createElement('thead');
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table rows
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 text-right';
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    td.className = 'py-3 px-6';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // Create CSV content and download link
            const csvContent = headers.join(',') + '\n' + data.map(row => headers.map(header => row[header]).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            downloadLink.href = url;
            downloadLink.download = `${reportType}-report-${new Date().toISOString().split('T')[0]}.csv`;
            downloadLinkContainer.classList.remove('hidden');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('menu-btn').addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobile-menu');
                mobileMenu.classList.toggle('hidden');
            });
        });
    </script>
</body>
</html>